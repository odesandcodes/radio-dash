<script is:inline>
    const player = document.getElementById('global-player');
    
    // Key exists only in memory for this specific session
    let sessionKey = null;

    const streams = {
        wqxr: 'https://stream.wqxr.org/wqxr.mp3',
        swiss: 'https://stream.srg-ssr.ch/m/rsc_de/mp3_128',
        salad: 'https://ice1.somafm.com/groovesalad-128-mp3',
        deep: 'https://ice1.somafm.com/deepspaceone-128-mp3',
        blender: 'https://ice1.somafm.com/beatblender-128-mp3'
    };
    
    let currentId = null;

    function toggleStation(id) {
        // No key in memory? Ask for it.
        if (!sessionKey) {
            const entry = prompt("Authorization Required:");
            if (!entry) return;
            sessionKey = entry;
        }
        
        const card = document.getElementById('card-' + id);
        if (currentId === id && !player.paused) {
            player.pause();
            card.classList.remove('playing');
            return;
        }
        
        document.querySelectorAll('.card').forEach(c => c.classList.remove('playing'));
        currentId = id;
        player.src = streams[id];
        player.play();
        card.classList.add('playing');
        sync(); 
    }

    async function sync() {
        if (!currentId || player.paused || !sessionKey) return;
        
        try {
            const r = await fetch(`/api/stations.json?id=${currentId}&key=${sessionKey}`);
            
            if (r.status === 403) {
                // Wrong password? Wipe the memory and stop.
                sessionKey = null;
                alert("Access Denied.");
                return;
            }

            if (r.ok) {
                const d = await r.json();
                document.getElementById(currentId + '-t').innerText = d.title;
                document.getElementById(currentId + '-c').innerText = d.comp;
            }
        } catch (e) {}
    }

    // Standard interval for metadata
    setInterval(sync, 30000);
</script>